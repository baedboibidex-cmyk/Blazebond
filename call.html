import { onAuthStateChanged } from "firebase/auth";
import { doc, setDoc, getDoc, updateDoc, collection, addDoc, onSnapshot } from "firebase/firestore";
import { auth, db } from "./firebase.js";

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const callStatus = document.getElementById("call-status");
const hangupBtn = document.getElementById("hangupBtn");

const urlParams = new URLSearchParams(window.location.search);
const callId = urlParams.get("callId");

let pc; // RTCPeerConnection

async function initCall() {
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    // Setup peer connection
    pc = new RTCPeerConnection();

    // Local stream
    const localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    localVideo.srcObject = localStream;

    // Remote stream
    const remoteStream = new MediaStream();
    remoteVideo.srcObject = remoteStream;
    pc.ontrack = event => event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));

    // Firestore references
    const callRef = doc(db, "calls", callId);
    const offerCandidates = collection(callRef, "offerCandidates");
    const answerCandidates = collection(callRef, "answerCandidates");

    // ICE candidates
    pc.onicecandidate = event => {
      if (event.candidate) {
        addDoc(offerCandidates, event.candidate.toJSON());
      }
    };

    // Caller flow
    const callDoc = await getDoc(callRef);
    if (!callDoc.exists()) {
      // Create offer
      const offerDescription = await pc.createOffer();
      await pc.setLocalDescription(offerDescription);

      await setDoc(callRef, { offer: { type: offerDescription.type, sdp: offerDescription.sdp }, status: "initiated" });
    }

    // Listen for answer
    onSnapshot(callRef, async snapshot => {
      const data = snapshot.data();
      if (data?.answer && !pc.currentRemoteDescription) {
        const answerDesc = new RTCSessionDescription(data.answer);
        await pc.setRemoteDescription(answerDesc);
        callStatus.innerText = "In Call";
      }
    });

    // Listen for ICE candidates from callee
    onSnapshot(answerCandidates, snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === "added") {
          const candidate = new RTCIceCandidate(change.doc.data());
          pc.addIceCandidate(candidate);
        }
      });
    });
  });
}

// Hang up
hangupBtn.addEventListener("click", async () => {
  if (pc) pc.close();
  const callRef = doc(db, "calls", callId);
  await updateDoc(callRef, { status: "ended" });
  window.location.href = "chat.html";
});

initCall();
